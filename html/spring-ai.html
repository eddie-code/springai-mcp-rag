<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>SpringAI å®æˆ˜</title>
    <link rel="stylesheet" href="../html/css/doctor/doctor.css">
    <link rel="stylesheet" href="../html/libs/element-2.15.13/index.css">
    <!-- <link rel="stylesheet" href="../html/css/theme/style/theme/index.css"> -->
    <style>
        .el-upload-dragger {
            width: 260px;
            height: 130px;
        }

        .tts-btn {
            background: #1890ff;
            color: white;
            border: none;
            border-radius: 3px;
            cursor: pointer;
            transition: background 0.3s;
        }

        .tts-btn:hover {
            background: #40a9ff;
        }

        .tts-btn:disabled {
            background: #d9d9d9;
            cursor: not-allowed;
        }
    </style>
</head>

<body>
<div class="chat-container" id="doctorPage">
    <div class="chat-header">
        Spring-AI MCPæœåŠ¡+RAGçŸ¥è¯†åº“ å®æˆ˜
    </div>
    <div class="chat-messages" id="chat-messages">

        <block v-for="(item, index) in chatList">
            <div class="message user" v-if="item.chatType === 'user'">
                <div class="text">{{ item.content }}</div>
                <div class="user-avatar">YJY</div>
            </div>
            <div class="message bot" v-else>
                <div class="avatar">AI</div>
                <div class="text" v-html="item.content"></div>
            </div>
        </block>

    </div>

    <div class="chat-input-container">
        <div class="chat-input-group">
            <div class="search-group">
                <div class="checkbox-group" id="searchOptionRadioGroup">
                    <label>
                        <input type="button"
                               :class="{'search-style': !internetSearchSelected, 'search-style-selected': internetSearchSelected}"
                               id="internetSearch" value="è”ç½‘æœç´¢" @click="doInternetSearch(internetSearchSelected)" />
                    </label>
                    <label>
                        <input type="button"
                               :class="{'search-style': !knowledgeSearchSelected, 'search-style-selected': knowledgeSearchSelected}"
                               id="knowledgeSearch" value="çŸ¥è¯†åº“æœç´¢"
                               @click="doKnowledgeSearch(knowledgeSearchSelected)" />
                    </label>
                    <label>
                        <input type="button"
                               :class="{'search-style': !ttsEnabled, 'search-style-selected': ttsEnabled}"
                               id="ttsToggle" value="è¯­éŸ³æ’­æŠ¥" @click="toggleTTS()" />
                    </label>
                    <!-- <label>
                        <input
                            type="button"
                            :class="{'search-style': !imageReadSelected, 'search-style-selected': imageReadSelected}"
                            id="knowledgeSearch"
                            value="ä¸Šä¼ å›¾ç‰‡"
                            @click="doImageRead(imageReadSelected)"/>
                    </label> -->
                </div>
            </div>

            <!-- TTSæ§åˆ¶é¢æ¿ -->
            <div class="tts-controls" v-if="ttsEnabled"
                 style="margin-top: 10px; padding: 10px; background: #f5f5f5; border-radius: 5px;">
                <div style="display: flex; align-items: center; gap: 10px; margin-bottom: 5px;">
                    <button @click="pauseTTS" :disabled="!isSpeaking" class="tts-btn"
                            style="padding: 5px 10px; font-size: 12px;">{{ isSpeaking ? 'æš‚åœ' : 'ç»§ç»­' }}</button>
                    <button @click="stopTTS" class="tts-btn" style="padding: 5px 10px; font-size: 12px;">åœæ­¢</button>
                    <span style="font-size: 12px; color: #666; margin-left: 10px;">è¯­é€Ÿ:</span>
                    <input type="range" v-model="speechRate" min="0.5" max="2" step="0.1" style="width: 60px;">
                    <span style="font-size: 12px; color: #666;">{{ speechRate }}x</span>
                    <span style="font-size: 12px; color: #666; margin-left: 10px;">éŸ³è°ƒ:</span>
                    <input type="range" v-model="speechPitch" min="0.5" max="2" step="0.1" style="width: 60px;">
                </div>
                <div style="display: flex; align-items: center; gap: 10px;">
                    <span style="font-size: 12px; color: #666;">å£°éŸ³:</span>
                    <select v-model="selectedVoice" @change="updateVoice" style="font-size: 12px; padding: 2px;">
                        <option v-for="voice in availableVoices" :key="voice.name" :value="voice">
                            {{ voice.name }} ({{ voice.lang }})
                        </option>
                    </select>
                    <span v-if="isSpeaking" style="font-size: 12px; color: #1890ff;">ğŸ”Š æ’­æ”¾ä¸­...</span>
                </div>
            </div>

            <div class="chat-input">
                <input type="text" id="user-input" class="user-input" value="" placeholder="è¯·è¾“å…¥å†…å®¹..."
                       @keydown="handleKeyDown(event)">
                <button id="btn-chat" class="btn-chat" @click="doChat()">å‘é€</button>
            </div>
        </div>

        <div class="upload-group">
            <div class="button-group">
                <!-- <button>ä¸Šä¼ çŸ¥è¯†åº“æ–‡æ¡£</button> -->
                <!-- å…è®¸ä¸Šä¼ PDFã€Wordæ–‡æ¡£ã€TEXTæ–‡æ¡£ -->
                <el-upload drag class="course-cover-uploader" action="" accept=".txt"
                           :http-request="p => uploadDoc(p)" :show-file-list="false">
                    <i class="el-icon-upload" style="margin-top: 20px;"></i>
                    <div class="el-upload__text" style="font-size: 13px;">æ‹–æ‹½æ–‡æ¡£ æˆ–<em>ç‚¹å‡»ä¸Šä¼ </em></div>
                    <div class="el-upload__tip" slot="tip">åªèƒ½ä¸Šä¼ textæ–‡æœ¬æ–‡ä»¶, ä¸”ä¸è¶…è¿‡10MBã€‚</div>
                </el-upload>
            </div>
        </div>
    </div>
</div>

</body>

<script src="../html/libs/vue.min.js"></script>
<script src="../html/libs/axios.min.js"></script>
<script src="../html/libs/jquery-3.4.1.min.js"></script>
<script src="../html/libs/js.cookie.min.js"></script>
<script src="../html/js/app.js"></script>

<script src="../html/libs/element-2.15.13/index.js"></script>
<script src="../html/libs/marked.min.js"></script>

<script src="../html/js/cookieUtils.js"></script>
<script src="../html/js/request.js"></script>
<script src="../html/js/apis/admin/doctorApi.js"></script>

<script>

    var doctorPage = new Vue({
        el: "#doctorPage",
        components: {
            // 'my-component': httpVueLoader('my-component.vue')
        },
        data() {
            return {
                botMsgId: null,
                currentUserName: null,
                chatList: [],

                internetSearchSelected: false,
                knowledgeSearchSelected: false,
                imageReadSelected: false,

                // TTSç›¸å…³å˜é‡
                ttsEnabled: false,
                isSpeaking: false,
                speechSynthesis: null,
                currentUtterance: null,
                speechRate: 1.0,
                speechPitch: 1.0,
                availableVoices: [],
                selectedVoice: null,
                speechQueue: [],
                isProcessingQueue: false,

                // æµå¼TTSç¼“å†²ç›¸å…³
                textBuffer: '',             // æ–‡æœ¬ç¼“å†²åŒº
                bufferTimeout: null,        // ç¼“å†²è¶…æ—¶å®šæ—¶å™¨
                lastReceiveTime: 0,         // ä¸Šæ¬¡æ¥æ”¶æ–‡æœ¬æ—¶é—´

                userId: null,
            }
        },
        created() {
            var me = this;
            // éšæœºç”Ÿæˆä¸€ä¸ª12ä½ç”¨æˆ·id
            var userId = Math.random().toString(36).substring(2, 12);
            console.log("userId = " + userId);
            this.initSSE(userId);
            this.initTTS();
        },
        mounted() {
            this.scrollToBottom();

        },
        watch: {
        },
        methods: {
            uploadDoc(params) {
                console.log("è‡ªå®šä¹‰ä¸Šä¼ ", params);

                const file = params.file;

                // å°è£…FormDataå¯¹è±¡
                var formData = new FormData();
                formData.append("file", params.file);

                doctorApi.uploadRagDoc(formData).then(response => {
                    console.log(response);
                    if (response.status == 200) {
                        this.$message.success('ä¸Šä¼ çŸ¥è¯†åº“æ–‡æ¡£æˆåŠŸï¼');
                    } else {
                        this.$message.error('ä¸Šä¼ çŸ¥è¯†åº“æ–‡æ¡£å¤±è´¥ï¼');
                    }

                });
            },

            initSSE(userId) {
                var me = this;

                let source = null;
                if (window.EventSource) {
                    // å»ºç«‹è¿æ¥
                    source = new EventSource('http://127.0.0.1:8080/sse/connect?userId=' + userId);
                    console.log("è¿æ¥ç”¨æˆ·=" + userId);
                    me.currentUserName = userId;

                    source.addEventListener('open', function (e) {
                        console.log("å»ºç«‹è¿æ¥ã€‚ã€‚ã€‚");
                    }, false);

                    source.addEventListener('add', function (e) {

                        // console.log("addäº‹ä»¶...");
                        console.log(e.data);
                        var receiveMsg = e.data;

                        var botMsgId = me.botMsgId;


                        var needNew = true;
                        for (var i = 0; i < me.chatList.length; i++) {
                            var chatItem = me.chatList[i];
                            if (chatItem.botMsgId == botMsgId) {
                                needNew = false;
                            }
                        }


                        // if (botMsgId == null || botMsgId == '') {
                        if (needNew) {
                            // botMsgId = me.generateRandomId(12);
                            me.botMsgId = botMsgId;
                            // console.log("botMsgId = " + botMsgId);

                            // ä¸ºç©ºï¼Œåˆ›å»ºæ–°å¯¹è±¡
                            var newBotContent = {
                                id: "temp",
                                content: receiveMsg,
                                // time: '2023-05-01 12:00:00',
                                userName: 'bot',
                                chatType: 'bot',
                                botMsgId: botMsgId,
                            };
                            me.chatList.push(newBotContent);

                        } else {
                            // console.log("botMsgId ä¸ä¸ºç©º...");
                            // console.log("botMsgId = " + botMsgId);

                            // ä¸ä¸ºç©ºï¼Œæ‰¾åˆ°å¯¹åº”çš„èŠå¤©è®°å½•æµå¼æ’å…¥æ•°æ®
                            for (var i = 0; i < me.chatList.length; i++) {
                                var chatItem = me.chatList[i];
                                if (chatItem.botMsgId == botMsgId) {
                                    // æ‰¾åˆ°å¯¹åº”çš„èŠå¤©è®°å½•æµå¼æ’å…¥æ•°æ®
                                    chatItem.content += receiveMsg;
                                }
                            }
                        }

                        // TTSå¤„ç† - ä½¿ç”¨ç¼“å†²ç­–ç•¥å¤„ç†æµå¼æ–‡æœ¬
                        if (me.ttsEnabled && receiveMsg && receiveMsg.trim()) {
                            me.addToTextBuffer(receiveMsg);
                        }

                        me.scrollToBottom();
                    });

                    source.addEventListener('finish', function (e) {
                        console.log("finishäº‹ä»¶...");
                        console.log(e.data);
                        var chatResponse = JSON.parse(e.data);
                        var message = chatResponse.message;
                        var botMsgId = chatResponse.botMsgId;

                        // var test = marked.parse(e.data);
                        // console.log(test);

                        for (var i = 0; i < me.chatList.length; i++) {
                            var chatItem = me.chatList[i];
                            if (chatItem.botMsgId == botMsgId) {
                                // æ‰¾åˆ°å¯¹åº”çš„èŠå¤©è®°å½•å¹¶ä¸”è½¬æ¢æˆhtml
                                chatItem.content = marked.parse(message);
                            }
                        }

                        me.botMsgId = null;

                        // TTSå¤„ç† - æµå¼ç»“æŸåå¤„ç†å‰©ä½™ç¼“å†²åŒºæ–‡æœ¬
                        if (me.ttsEnabled) {
                            me.flushTextBuffer();
                        }

                        me.scrollToBottom();
                    });

                    source.addEventListener('error', function (e) {
                        console.log("erroräº‹ä»¶...");
                        console.log("e.readyState: " + source.readyState);

                        if (e.readyState === EventSource.CLOSED) {
                            console.log('connection is closed');
                        } else {
                            console.log("Error occured", event);
                        }
                        // closeæ–¹æ³•ç”¨äºå…³é—­è¿æ¥
                        source.close();
                    });

                    source.addEventListener("customEvent", function (e) {
                        console.log(e.lastEventId);
                        console.log(e.data);
                    }, false);
                } else {
                    console.log("æµè§ˆå™¨ä¸æ”¯æŒSSE");
                }
            },

            handleKeyDown(event) {
                if (event.key === 'Enter') {
                    this.doChat();
                }
            },

            doChat() {
                var me = this;
                // å¦‚æœ currentUserName ä¸ºç©ºï¼Œä½¿ç”¨ä¹‹å‰ç”Ÿæˆçš„ userId
                var currentUserName = this.currentUserName

                var botMsgId = me.generateRandomId(12);
                me.botMsgId = botMsgId;

                const userInput = document.getElementById('user-input').value;
                var pendingMsg = userInput.trim();
                if (pendingMsg === '') return;

                // å‘é€æ¶ˆæ¯åˆ°åç«¯
                var singleChat = {
                    currentUserName: currentUserName,
                    message: pendingMsg,
                    botMsgId: botMsgId
                };

                var internetSearchSelected = this.internetSearchSelected;
                var knowledgeSearchSelected = this.knowledgeSearchSelected;

                if (knowledgeSearchSelected && !internetSearchSelected) {
                    console.log("ragSearch");
                    doctorApi.ragSearch(singleChat);
                } else if (!knowledgeSearchSelected && internetSearchSelected) {
                    console.log("internetSearch");
                    doctorApi.internetSearch(singleChat);
                } else {
                    console.log("doChat");
                    doctorApi.doChat(singleChat);
                }

                var newUserContent = {
                    content: pendingMsg,
                    userName: currentUserName,
                    chatType: 'user',
                }
                this.chatList.push(newUserContent);

                document.getElementById('user-input').value = '';
            },

            generateRandomId(length) {
                const characters = 'ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789';
                let result = '';
                const charactersLength = characters.length;
                for (let i = 0; i < length; i++) {
                    result += characters.charAt(Math.floor(Math.random() * charactersLength));
                }
                return result;
            },

            scrollToBottom() {
                const chatMessages = document.getElementById('chat-messages');
                chatMessages.scrollTop = chatMessages.scrollHeight;
            },

            doInternetSearch(internetSearchSelected) {
                this.internetSearchSelected = !internetSearchSelected;

                if (this.internetSearchSelected) {
                    this.knowledgeSearchSelected = false;
                    this.imageReadSelected = false;
                }
            },

            doKnowledgeSearch(knowledgeSearchSelected) {
                this.knowledgeSearchSelected = !knowledgeSearchSelected;

                if (this.knowledgeSearchSelected) {
                    this.internetSearchSelected = false;
                    this.imageReadSelected = false;
                }
            },

            doImageRead(imageReadSelected) {
                this.imageReadSelected = !imageReadSelected;

                if (this.imageReadSelected) {
                    this.knowledgeSearchSelected = false;
                    this.internetSearchSelected = false;
                }
            },

            // ========== TTSç›¸å…³æ–¹æ³• ==========

            // åˆå§‹åŒ–TTS
            initTTS() {
                console.log("åˆå§‹åŒ–TTS...");
                if ('speechSynthesis' in window) {
                    this.speechSynthesis = window.speechSynthesis;
                    this.loadVoices();

                    // ç›‘å¬voicesæ”¹å˜äº‹ä»¶
                    if (speechSynthesis.onvoiceschanged !== undefined) {
                        speechSynthesis.onvoiceschanged = () => {
                            this.loadVoices();
                        };
                    }
                } else {
                    console.warn('å½“å‰æµè§ˆå™¨ä¸æ”¯æŒè¯­éŸ³åˆæˆAPI');
                    this.$message && this.$message.warning('å½“å‰æµè§ˆå™¨ä¸æ”¯æŒè¯­éŸ³åˆæˆåŠŸèƒ½');
                }
            },

            // åŠ è½½å¯ç”¨å£°éŸ³
            loadVoices() {
                const voices = this.speechSynthesis.getVoices();
                this.availableVoices = voices.filter(voice =>
                    voice.lang.includes('zh') || voice.lang.includes('en')
                );

                // é»˜è®¤é€‰æ‹©ä¸­æ–‡å£°éŸ³ï¼Œå¦‚æœæ²¡æœ‰åˆ™é€‰æ‹©ç¬¬ä¸€ä¸ª
                if (this.availableVoices.length > 0) {
                    const chineseVoice = this.availableVoices.find(voice =>
                        voice.lang.includes('zh') || voice.name.includes('Chinese')
                    );
                    this.selectedVoice = chineseVoice || this.availableVoices[0];
                }

                console.log('å¯ç”¨å£°éŸ³:', this.availableVoices);
            },

            // åˆ‡æ¢TTSå¼€å…³
            toggleTTS() {
                this.ttsEnabled = !this.ttsEnabled;
                if (this.ttsEnabled) {
                    console.log('TTSå·²å¯ç”¨');
                    this.$message && this.$message.success('è¯­éŸ³æ’­æŠ¥å·²å¯ç”¨');
                } else {
                    console.log('TTSå·²ç¦ç”¨');
                    this.stopTTS();
                    this.$message && this.$message.info('è¯­éŸ³æ’­æŠ¥å·²ç¦ç”¨');
                }
            },

            // æ·»åŠ æ–‡æœ¬åˆ°ç¼“å†²åŒºï¼ˆæ–°çš„æµå¼TTSå¤„ç†æ–¹æ³•ï¼‰
            addToTextBuffer(text) {
                if (!this.ttsEnabled || !text || !text.trim()) return;

                // æ›´æ–°æœ€åæ¥æ”¶æ—¶é—´
                this.lastReceiveTime = Date.now();

                // å°†æ–‡æœ¬æ·»åŠ åˆ°ç¼“å†²åŒº
                this.textBuffer += text;

                // æ¸…é™¤ä¹‹å‰çš„è¶…æ—¶å®šæ—¶å™¨
                if (this.bufferTimeout) {
                    clearTimeout(this.bufferTimeout);
                }

                // æ£€æŸ¥æ˜¯å¦é‡åˆ°å¥å­ç»“æŸç¬¦ï¼Œå¦‚æœæ˜¯åˆ™ç«‹å³å¤„ç†
                if (this.shouldFlushBuffer(this.textBuffer)) {
                    this.flushTextBuffer();
                } else {
                    // è®¾ç½®å»¶è¿Ÿå¤„ç†ï¼Œé˜²æ­¢æ–‡æœ¬æµä¸­æ–­å¤ªä¹…
                    this.bufferTimeout = setTimeout(() => {
                        if (this.textBuffer.trim()) {
                            this.flushTextBuffer();
                        }
                    }, 1500); // 1.5ç§’åå¼ºåˆ¶å¤„ç†ç¼“å†²åŒº
                }
            },

            // åˆ¤æ–­æ˜¯å¦åº”è¯¥åˆ·æ–°ç¼“å†²åŒº
            shouldFlushBuffer(text) {
                // æ£€æŸ¥æ˜¯å¦åŒ…å«å¥å­ç»“æŸç¬¦
                const sentenceEnders = /[ã€‚ï¼ï¼Ÿ.!?]+[\s]*$/;
                if (sentenceEnders.test(text.trim())) {
                    return true;
                }

                // æ£€æŸ¥æ˜¯å¦åŒ…å«æ®µè½åˆ†éš”ç¬¦
                const paragraphBreaks = /\n\s*\n|\r\n\s*\r\n/;
                if (paragraphBreaks.test(text)) {
                    return true;
                }

                // ç¼“å†²åŒºå¤ªé•¿æ—¶å¼ºåˆ¶å¤„ç†ï¼ˆé¿å…å¥å­è¿‡é•¿ï¼‰
                if (text.length > 200) {
                    return true;
                }

                return false;
            },

            // åˆ·æ–°æ–‡æœ¬ç¼“å†²åŒºåˆ°è¯­éŸ³é˜Ÿåˆ—
            flushTextBuffer() {
                if (!this.textBuffer.trim()) return;

                const bufferedText = this.textBuffer.trim();
                this.textBuffer = ''; // æ¸…ç©ºç¼“å†²åŒº

                // æ¸…é™¤è¶…æ—¶å®šæ—¶å™¨
                if (this.bufferTimeout) {
                    clearTimeout(this.bufferTimeout);
                    this.bufferTimeout = null;
                }

                // å°†ç¼“å†²çš„æ–‡æœ¬æŒ‰å¥å­åˆ†å‰²å¹¶æ·»åŠ åˆ°è¯­éŸ³é˜Ÿåˆ—
                this.processSentences(bufferedText);
            },

            // å¤„ç†å¥å­ï¼ŒæŒ‰æ ‡ç‚¹ç¬¦å·åˆ†å‰²
            processSentences(text) {
                // æŒ‰å¥å­åˆ†å‰²ï¼ˆä¸­è‹±æ–‡æ ‡ç‚¹ï¼‰
                const sentences = text.split(/([ã€‚ï¼ï¼Ÿ.!?]+)/).filter(s => s.trim());
                let currentSentence = '';

                for (let i = 0; i < sentences.length; i++) {
                    const part = sentences[i];
                    currentSentence += part;

                    // å¦‚æœæ˜¯æ ‡ç‚¹ç¬¦å·æˆ–å·²åˆ°æœ€åä¸€ä¸ªç‰‡æ®µï¼Œåˆ™å¤„ç†å½“å‰å¥å­
                    if (/[ã€‚ï¼ï¼Ÿ.!?]+/.test(part) || i === sentences.length - 1) {
                        if (currentSentence.trim()) {
                            this.addToSpeechQueue(currentSentence.trim());
                            currentSentence = '';
                        }
                    }
                }
            },

            // æ·»åŠ æ–‡æœ¬åˆ°è¯­éŸ³é˜Ÿåˆ—
            addToSpeechQueue(text) {
                if (!this.ttsEnabled || !text || !text.trim()) return;

                // æ¸…ç†æ–‡æœ¬ï¼Œç§»é™¤markdownæ ‡è®°å’Œç‰¹æ®Šå­—ç¬¦
                const cleanText = this.cleanTextForSpeech(text);
                if (!cleanText) return;

                this.speechQueue.push(cleanText);
                this.processSpeechQueue();
            },

            // æ¸…ç†æ–‡æœ¬ç”¨äºè¯­éŸ³åˆæˆ
            cleanTextForSpeech(text) {
                if (!text) return '';

                return text
                    .replace(/[#*`_~\[\]()]/g, '') // ç§»é™¤markdownæ ‡è®°
                    .replace(/\s+/g, ' ') // åˆå¹¶å¤šä¸ªç©ºæ ¼
                    .replace(/[^\u4e00-\u9fa5\u3400-\u4dbf\uf900-\ufaff\u3040-\u309f\u30a0-\u30ff\uac00-\ud7af\u0100-\u017f\u1e00-\u1eff\u0180-\u024f\u1ea0-\u1ef9a-zA-Z0-9\s\.,!?;:""''ï¼ˆï¼‰ã€‚ï¼Œï¼ï¼Ÿï¼›ï¼š]/g, '') // ä¿ç•™ä¸­è‹±æ–‡ã€æ•°å­—å’Œå¸¸ç”¨æ ‡ç‚¹
                    .trim();
            },

            // å¤„ç†è¯­éŸ³é˜Ÿåˆ—
            processSpeechQueue() {
                if (this.isProcessingQueue || this.speechQueue.length === 0 || !this.ttsEnabled) {
                    return;
                }

                this.isProcessingQueue = true;
                const text = this.speechQueue.shift();

                if (text && text.length > 0) {
                    this.speak(text);
                }
            },

            // è¯­éŸ³åˆæˆæ ¸å¿ƒæ–¹æ³•
            speak(text) {
                if (!this.speechSynthesis || !text) {
                    this.isProcessingQueue = false;
                    return;
                }

                // åœæ­¢å½“å‰æ’­æ”¾
                this.speechSynthesis.cancel();

                const utterance = new SpeechSynthesisUtterance(text);

                // è®¾ç½®è¯­éŸ³å‚æ•°
                utterance.rate = parseFloat(this.speechRate);
                utterance.pitch = parseFloat(this.speechPitch);
                utterance.volume = 1.0;

                if (this.selectedVoice) {
                    utterance.voice = this.selectedVoice;
                    utterance.lang = this.selectedVoice.lang;
                }

                // è®¾ç½®äº‹ä»¶ç›‘å¬
                utterance.onstart = () => {
                    console.log('å¼€å§‹æ’­æ”¾:', text);
                    this.isSpeaking = true;
                    this.currentUtterance = utterance;
                };

                utterance.onend = () => {
                    console.log('æ’­æ”¾ç»“æŸ:', text);
                    this.isSpeaking = false;
                    this.currentUtterance = null;
                    this.isProcessingQueue = false;

                    // ç»§ç»­å¤„ç†é˜Ÿåˆ—
                    setTimeout(() => {
                        this.processSpeechQueue();
                    }, 100);
                };

                utterance.onerror = (event) => {
                    console.error('è¯­éŸ³åˆæˆé”™è¯¯:', event.error);
                    this.isSpeaking = false;
                    this.currentUtterance = null;
                    this.isProcessingQueue = false;

                    // ç»§ç»­å¤„ç†é˜Ÿåˆ—
                    setTimeout(() => {
                        this.processSpeechQueue();
                    }, 100);
                };

                // å¼€å§‹è¯­éŸ³åˆæˆ
                this.speechSynthesis.speak(utterance);
            },

            // æš‚åœ/ç»§ç»­TTS
            pauseTTS() {
                if (!this.speechSynthesis) return;

                if (this.isSpeaking) {
                    this.speechSynthesis.pause();
                    this.isSpeaking = false;
                    console.log('è¯­éŸ³å·²æš‚åœ');
                } else {
                    this.speechSynthesis.resume();
                    this.isSpeaking = true;
                    console.log('è¯­éŸ³å·²ç»§ç»­');
                }
            },

            // åœæ­¢TTS
            stopTTS() {
                if (!this.speechSynthesis) return;

                this.speechSynthesis.cancel();
                this.isSpeaking = false;
                this.currentUtterance = null;
                this.speechQueue = [];
                this.isProcessingQueue = false;

                // æ¸…ç†ç¼“å†²åŒºç›¸å…³çŠ¶æ€
                this.textBuffer = '';
                if (this.bufferTimeout) {
                    clearTimeout(this.bufferTimeout);
                    this.bufferTimeout = null;
                }

                console.log('è¯­éŸ³å·²åœæ­¢ï¼Œç¼“å†²åŒºå·²æ¸…ç†');
            },

            // æ›´æ–°å£°éŸ³
            updateVoice() {
                console.log('å£°éŸ³å·²æ›´æ¢ä¸º:', this.selectedVoice ? this.selectedVoice.name : 'é»˜è®¤');
            },
        }
    });

</script>